/** Skins viewer module
 */

var fs = require('fs');
var path = require('path');

// all available skins
var knownSkins = {};

// ToDo: move to options
var scanDirs = ['skins'];
var filename = 'bootstrap.css';

// iterate all skin dirs, validate and store to dict
scanDirs.map(function (dir) {
    var pathToSkins = path.join(global.opts.core.common.pathToUser, dir);
    if (fs.existsSync(pathToSkins)) {
        knownSkins[dir] = {};
        fs.readdirSync(pathToSkins).map(function (skinName) {
            // Check if file exist inside skin dir
            if (fs.existsSync(path.join(pathToSkins, skinName, filename))) {
                knownSkins[dir][skinName] = {
                    'name': skinName.charAt(0).toUpperCase() + skinName.slice(1),
                    'path': path.join('..', dir, skinName)
                };
            }
        });
    }
});

/** Process request to skin catalog with GET param '?skin=SKIN'
 */
exports.process = function (req, res, next) {
    var skin = req.query.skin || '';
    var info = req.specData.info;
    if (info && info.role == 'skins-viewer' && info.path in knownSkins) {
        if (skin in knownSkins[info.path]) {
            // Skin found
            info.skin = knownSkins[info.path][skin];
        } else {
            // Invalid skin - show all available
            info.availableSkins = knownSkins[info.path];
        }
    }
    // continue processing
    next();
};
